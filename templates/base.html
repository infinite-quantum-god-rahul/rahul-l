{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="2025-08-30 19:30:00">
    <title>Spoorthi MACS Ltd., - v2025-08-30-18-20</title>
    <link rel="icon" href="/static/images/smlLogo1.ico" type="image/x-icon">

    <!-- Main CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/modal_fix.css">
    
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Sidebar hover guard (unchanged) -->
    <style>
      .sidebar .dropdown-menu { display:none !important; }
      .sidebar .dropdown.open > .dropdown-menu { display:block !important; }
      .sidebar .dropdown:hover > .dropdown-menu,
      .sidebar .dropdown:hover .dropdown-menu { display:none !important; }
    </style>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Order of scripts matters -->
    <script src="/static/js/unfreeze.inject.js" defer></script>

    <!-- Core helpers -->
    <script src="/static/js/admin.core.js" defer></script>
    <script src="/static/js/forms.validation.js" defer></script>

    <!-- Enable modal router but with proper order -->
    <script>
      window.DISABLE_ENTITY_MODAL_ROUTER = false;         // enable modals
    </script>

    <!-- Modal system - load in correct order -->
    <script src="/static/js/modals.crud.js?v=2025-09-01-12-50" defer></script>
    <script src="/static/js/forms.validation.js?v=2025-09-01-16-50" defer></script>
    
    <!-- Media + login helpers -->
    <script src="/static/js/media.image.login.js?v=2025-08-30-19-30" defer></script>
    
    <!-- UserProfile Modal Fix - BANKING-GRADE SOLUTION -->
    
    <!-- UserProfile Modal Fix - CLEAN SOLUTION -->
    <script>
        // Global role flags for JavaScript access
        window.roleFlags = {{ role_flags|safe|default:"{}" }};
        
        // Prevent loading of old userprofile_modal_fix.js
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            const element = originalCreateElement.call(this, tagName);
            if (tagName.toLowerCase() === 'script') {
                const originalSetAttribute = element.setAttribute;
                element.setAttribute = function(name, value) {
                    if (name === 'src' && value && value.includes('userprofile_modal_fix')) {
                        return element; // Don't set the src
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }
            return element;
        };
        
        // Override fetch to block requests to the old file
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (typeof url === 'string' && url.includes('userprofile_modal_fix.js')) {
                return Promise.reject(new Error('Blocked request to old userprofile_modal_fix.js'));
            }
            return originalFetch.call(this, url, options);
        };
        
        // Override XMLHttpRequest to block requests to the old file
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
            if (typeof url === 'string' && url.includes('userprofile_modal_fix.js')) {
                // Create a fake response
                this.readyState = 4;
                this.status = 404;
                this.statusText = 'Not Found';
                this.responseText = '';
                setTimeout(() => {
                    if (this.onreadystatechange) {
                        this.onreadystatechange();
                    }
                }, 0);
                return;
            }
            return originalXHROpen.call(this, method, url, async, user, password);
        };
        
        // Clear any cached script references
        document.addEventListener('DOMContentLoaded', function() {
            // Remove any cached script tags that might reference old files
            const scripts = document.querySelectorAll('script[src*="userprofile_modal_fix"]');
            scripts.forEach(script => {
                script.remove();
            });
            
            // Ensure UserProfile modal works properly
            const originalOpenEntityModal = window.openEntityModal;
            if (originalOpenEntityModal) {
                window.openEntityModal = function(entityOrEvent) {
                    let entity;
                    if (typeof entityOrEvent === "string") {
                        entity = entityOrEvent;
                    } else if (entityOrEvent?.currentTarget) {
                        const el = entityOrEvent.currentTarget;
                        entity = el.dataset.entity || el.getAttribute("data-entity") || "";
                    }
                    
                    // Call original function for all entities including UserProfile
                    return originalOpenEntityModal.call(this, entityOrEvent);
                };
            }
        });
    </script>

    <!-- Basic modal styling without interfering with functionality -->
    <style>
        /* Basic form field improvements */
        .form-control, select, textarea {
          width: 100%;
          box-sizing: border-box;
        }
        
        .col-12 {
          width: 100%;
          padding: 0 15px;
        }
        
        .form-section {
          margin-bottom: 20px;
        }
        
        .section-title {
          margin-bottom: 15px;
          color: #495057;
          font-weight: 600;
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body>

<!-- Header -->
<header class="fixed-header">
  <div class="header-left">
    <div class="logo">
      <img src="/static/images/smlLogo1.ico" alt="Logo">
      <strong>Spoorthi MACS Ltd.,</strong>
    </div>
  </div>

  {% if user.is_authenticated %}
    <div class="header-center user-meta" style="font-size:14px;color:#f2f2f2;">
      <span><strong>
        {% if header_user_display_name %}{{ header_user_display_name }}
        {% else %}{{ user.get_full_name|default:user.username }}{% endif %}
      </strong></span>

      {% if header_branch_name %}
        <span> • Branch: <strong>{{ header_branch_name }}</strong></span>
      {% elif user.userprofile and user.userprofile.branch %}
        <span> • Branch: <strong>{{ user.userprofile.branch.name }}</strong></span>
      {% elif staff_info and staff_info.branch %}
        <span> • Branch: <strong>{{ staff_info.branch.name }}</strong></span>
      {% endif %}

      {% if header_role_label %}
        <span> • <span class="role-badge">{{ header_role_label }}</span></span>
      {% elif user.is_superuser %}
        <span> • <span class="role-badge">Superuser</span></span>
      {% elif user.is_staff %}
        <span> • <span class="role-badge">Staff</span></span>
      {% endif %}
    </div>
  {% endif %}

  <nav class="top-nav header-right">
    <a href="#">About</a>
    <a href="#">Career</a>
    {% if user.is_authenticated %}
      <a href="{% url 'logout' %}">Logout</a>
      <form action="{% url 'switch_account' %}" method="post" style="display:inline; margin-left:10px;">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning" style="vertical-align: middle;">
          Login different user
        </button>
      </form>
    {% else %}
      <a href="#" onclick="openLoginModal()">Login</a>
    {% endif %}
  </nav>
</header>

<!-- Login Modal -->
{% include "companies/login_modal.html" %}

<!-- Main Layout -->
<div class="dashboard-flex">
  {% block content %}{% endblock %}
</div>

<!-- Entity Modal -->
<div id="entity-modal" class="modal" style="display: none;" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entity-modal-title">Loading...</h5>
        <button type="button" class="btn-close" onclick="closeEntityModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="entity-modal-body">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading form...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal CSS -->
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal.show {
    display: block;
  }
  
  .modal-dialog {
    position: relative;
    width: auto;
    margin: 1.75rem auto;
    max-width: 800px;
  }
  
  .modal-content {
    position: relative;
    background-color: #fff;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
  }
  
  .modal-body {
    padding: 1rem;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .btn-close {
    background: transparent;
    border: 0;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 1.5rem;
    height: 1.5rem;
  }
  
  .btn-close:hover {
    opacity: 0.75;
  }
  
  /* Form field improvements */
  #entity-modal select,
  #entity-modal input[type="text"],
  #entity-modal input[type="email"],
  #entity-modal input[type="password"],
  #entity-modal input[type="number"],
  #entity-modal textarea {
    width: 100% !important;
    padding: 8px !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
    box-sizing: border-box !important;
  }
  
  #entity-modal .form-group {
    margin-bottom: 1rem;
  }
  
  #entity-modal label {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
</style>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- SIMPLE WORKING MODAL - JUST CANCEL BUTTON -->
    <script>
    console.log('🔧 SIMPLE MODAL LOADED - Focus on cancel button working');
    
    // Simple modal functions - JUST MAKE CANCEL WORK
    window.openEntityModal = function(entity) {
        console.log('🔧 Opening modal for:', entity);
        const modal = document.getElementById('entity-modal');
        if (!modal) {
            console.log('🔧 Modal not found, creating it');
            // Create modal if it doesn't exist
            const modalHTML = `
                <div id="entity-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="entity-modal-title" style="margin: 0;">Create ${entity}</h3>
                            <button id="modal-close-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">×</button>
                        </div>
                        <div id="entity-modal-body" style="padding: 20px;">
                            <div style="text-align: center; padding: 40px;">
                                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                                <p>Loading form...</p>
                            </div>
                        </div>
                        <div style="padding: 20px; border-top: 1px solid #eee; text-align: right;">
                            <button id="modal-cancel-btn" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin-right: 10px; cursor: pointer;">Cancel</button>
                            <button id="modal-save-btn" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; disabled: true;">Save</button>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Show modal
        const modal = document.getElementById('entity-modal');
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Setup cancel button - THIS IS THE KEY PART
        const cancelBtn = document.getElementById('modal-cancel-btn');
        const closeBtn = document.getElementById('modal-close-btn');
        
        if (cancelBtn) {
            cancelBtn.onclick = function() {
                console.log('🔧 Cancel button clicked - closing modal');
                closeModal();
            };
        }
        
        if (closeBtn) {
            closeBtn.onclick = function() {
                console.log('🔧 Close button clicked - closing modal');
                closeModal();
            };
        }
        
        // Try to load form, but don't let it break the cancel button
        try {
            const base = `/${entity.toLowerCase()}/`;
            const url = `${base}get/`;
            
            fetch(url, {
                headers: { 
                    "X-Requested-With": "XMLHttpRequest", 
                    "Accept": "application/json,text/html" 
                },
                credentials: "include"
            })
            .then(response => response.text())
            .then(html => {
                const modalBody = document.getElementById('entity-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = html;
                }
            })
            .catch(error => {
                console.log('🔧 Error loading form, but cancel button still works:', error);
                const modalBody = document.getElementById('entity-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; border: 1px solid #f5c6cb;">
                            <h4>Error Loading Form</h4>
                            <p>${error.message}</p>
                            <p><strong>But the Cancel button still works!</strong></p>
                        </div>
                    `;
                }
            });
        } catch (error) {
            console.log('🔧 Error in form loading, but cancel button still works:', error);
        }
    };
    
    function closeModal() {
        console.log('🔧 Closing modal');
        const modal = document.getElementById('entity-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    window.closeEntityModal = closeModal;
    
    // Make sure cancel button works even if other things fail
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔧 DOM loaded - ensuring cancel button works');
        
        // Find all buttons that might open modals
        const buttons = document.querySelectorAll('button, a, [onclick*="UserCreation"], [onclick*="openEntityModal"]');
        
        buttons.forEach(button => {
            const text = button.textContent.toLowerCase();
            const onclick = button.getAttribute('onclick') || '';
            
            if (text.includes('user') || text.includes('add') || text.includes('create') || 
                onclick.includes('UserCreation') || onclick.includes('openEntityModal')) {
                
                console.log('🔧 Found button to replace:', button);
                
                // Remove old onclick
                button.removeAttribute('onclick');
                
                // Add new click handler
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔧 Button clicked, opening modal');
                    window.openEntityModal('UserCreation');
                });
            }
        });
        
        console.log('🔧 Button setup complete - cancel button will work!');
    });
    </script>
</body>
</html>