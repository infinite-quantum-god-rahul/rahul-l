{% extends "base.html" %}
{% load custom_tags %}

{% block title %}Dashboard - Spoorthi MACS Ltd.,{% endblock %}

{% block content %}
<div class="dashboard-flex">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    {% with p=profile %}
    <ul class="sidebar-menu">

      {% if p %}
        {% if not user.is_superuser and not p.is_admin and not p.is_master %}
          <li><a href="{% url 'entity_list' 'FieldReport' %}">{{ "FieldReport"|pretty_name }}</a></li>
          <li class="dropdown">
            <a href="#">Report ▸</a>
            <ul class="dropdown-menu">
              <li><a href="{% url 'entity_list' 'WeeklyReport' %}">Weekly</a></li>
              <li><a href="{% url 'entity_list' 'MonthlyReport' %}">Monthly</a></li>
            </ul>
          </li>
          {% if user.is_superuser or p.is_admin or SML_FEATURES.NPA_DASHBOARD %}
            <li><a href="{% url 'npa_dashboard' %}">NPA Dashboard</a></li>
          {% endif %}
        {% else %}

          {% if user.is_superuser or p.is_admin or p.is_master %}
            <li class="dropdown">
              <a href="#">Create ▸</a>
              <ul class="dropdown-menu">
                <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
                <!-- Hard navigate to dedicated UserProfile page -->
                <li><a data-hard-nav="1" href="{% url 'userprofile_get' %}">{{ "UserProfile"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
                <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
              </ul>
            </li>
          {% endif %}

          {% if user.is_superuser or p.is_admin or p.is_master or p.is_manager %}
            <li class="dropdown">
              <a href="#">HRPM ▸</a>
              <ul class="dropdown-menu">
                <li><a href="{% url 'hrpm_staff' %}">{{ "Staff"|pretty_name }}</a></li>
                <li><a href="{% url 'hrpm_appointment' %}">{{ "Appointment"|pretty_name }}</a></li>
                <li><a href="{% url 'hrpm_salary_statement' %}">{{ "Salary Statement"|pretty_name }}</a></li>
              </ul>
            </li>
          {% endif %}

          {% if user.is_superuser or p.is_admin %}
            {% for model in "Role,Product,Client,LoanApplication,LoanApproval,Disbursement,BusinessSetting,FieldSchedule,FieldReport,Prepaid,Mortgage,ExSaving,AccountHead,Voucher,Posting,RecoveryPosting,UserPermission,Payment,Repayment,LoanRestructure,Notification,GatewayEvent,EWIFlag"|split:"," %}
              <li><a href="{% url 'entity_list' model %}">{{ model|pretty_name }}</a></li>
            {% endfor %}
            <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'AlertRule' %}">{{ "AlertRule"|pretty_name }}</a></li>
          {% else %}
            {% if p.is_data_entry %}
              {% for model in "Client,LoanApplication,RecoveryPosting"|split:"," %}
                <li><a href="{% url 'entity_list' model %}">{{ model|pretty_name }}</a></li>
              {% endfor %}
              {% if user.is_superuser or p.is_admin or SML_FEATURES.OFFLINE_KYC %}
                <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
              {% endif %}
            {% endif %}

            {% if p.is_accounting %}
              {% for model in "Voucher,Posting,AccountHead"|split:"," %}
                <li><a href="{% url 'entity_list' model %}">{{ model|pretty_name }}</a></li>
              {% endfor %}
            {% endif %}

            {% if p.is_manager %}
              {% for model in "Client,LoanApplication,RecoveryPosting,Voucher,Posting,AccountHead"|split:"," %}
                <li><a href="{% url 'entity_list' model %}">{{ model|pretty_name }}</a></li>
              {% endfor %}
              {% if user.is_superuser or p.is_admin or SML_FEATURES.OFFLINE_KYC %}
                <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
              {% endif %}
            {% endif %}

            {% if p.is_recovery_agent %}
              <li><a href="{% url 'entity_list' 'RecoveryPosting' %}">{{ "RecoveryPosting"|pretty_name }}</a></li>
            {% endif %}

            {% if p.is_reports or p.is_auditor %}
              <li><a href="{% url 'entity_list' 'FieldReport' %}">{{ "FieldReport"|pretty_name }}</a></li>
            {% endif %}
          {% endif %}

          {% if user.is_superuser or p.is_admin or p.is_reports or p.is_auditor %}
            <li class="dropdown">
              <a href="#">Report ▸</a>
              <ul class="dropdown-menu">
                <li><a href="{% url 'entity_list' 'WeeklyReport' %}">Weekly</a></li>
                <li><a href="{% url 'entity_list' 'MonthlyReport' %}">Monthly</a></li>
              </ul>
            </li>
          {% endif %}

          {% if user.is_superuser or p.is_admin or SML_FEATURES.NPA_DASHBOARD %}
            <li><a href="{% url 'npa_dashboard' %}">NPA Dashboard</a></li>
          {% endif %}
          {% if user.is_superuser or p.is_admin or SML_FEATURES.CREDIT_BUREAU %}
            <li><a href="#" onclick="openCreditPullModal()">Credit Bureau Check</a></li>
          {% endif %}
          {% if user.is_superuser or p.is_admin or SML_FEATURES.OFFLINE_KYC %}
            <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
          {% endif %}
          {% if user.is_superuser or p.is_admin or SML_FEATURES.ESCALATION_ALERTS %}
            <li><a href="{% url 'entity_list' 'AlertRule' %}">{{ "AlertRule"|pretty_name }}</a></li>
          {% endif %}
        {% endif %}
      {% else %}
        {% if user.is_superuser %}
          <li class="dropdown">
            <a href="#">Create ▸</a>
            <ul class="dropdown-menu">
              <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
              <!-- Hard navigate to dedicated UserProfile page -->
              <li><a data-hard-nav="1" href="{% url 'userprofile_get' %}">{{ "UserProfile"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
            </ul>
          </li>

          <li class="dropdown">
            <a href="#">HRPM ▸</a>
            <ul class="dropdown-menu">
              <li><a href="{% url 'hrpm_staff' %}">{{ "Staff"|pretty_name }}</a></li>
              <li><a href="{% url 'hrpm_appointment' %}">{{ "Appointment"|pretty_name }}</a></li>
              <li><a href="{% url 'hrpm_salary_statement' %}">{{ "Salary Statement"|pretty_name }}</a></li>
            </ul>
          </li>

          {% for model in "Role,Product,Client,LoanApplication,LoanApproval,Disbursement,BusinessSetting,FieldSchedule,FieldReport,Prepaid,Mortgage,ExSaving,AccountHead,Voucher,Posting,RecoveryPosting,UserPermission,Payment,Repayment,LoanRestructure,Notification,GatewayEvent,EWIFlag"|split:"," %}
            <li><a href="{% url 'entity_list' model %}">{{ model|pretty_name }}</a></li>
          {% endfor %}
          <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
          <li><a href="{% url 'entity_list' 'AlertRule' %}">{{ "AlertRule"|pretty_name }}</a></li>

          <li class="dropdown">
            <a href="#">Report ▸</a>
            <ul class="dropdown-menu">
              <li><a href="{% url 'entity_list' 'WeeklyReport' %}">Weekly</a></li>
              <li><a href="{% url 'entity_list' 'MonthlyReport' %}">Monthly</a></li>
            </ul>
          </li>

          <li><a href="{% url 'npa_dashboard' %}">NPA Dashboard</a></li>
          <li><a href="#" onclick="openCreditPullModal()">Credit Bureau Check</a></li>
        {% endif %}
      {% endif %}

    </ul>
    {% endwith %}
  </div>

  <!-- Main Content + Toggle Button Container -->
  <div class="admin-main-content">
    <div class="user-meta-header d-flex justify-content-end align-items-center p-2" style="font-size: 14px; color: #666;">
      {% if header_user_display_name or header_branch_name or header_role_label %}
        <strong>{{ header_user_display_name }}</strong>
        {% if header_branch_name %} | <span>{{ header_branch_name }}</span>{% endif %}
        {% if header_role_label %} | <span>{{ header_role_label }}</span>{% endif %}
      {% endif %}
    </div>

    <button id="sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">&#9776;</button>

    {% if include_template %}
      {% include include_template %}
    {% else %}
      <div class="p-4">
        <h1>Welcome</h1>
        <p>Select an option from the sidebar to manage the system.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Universal Image Preview Modal -->
<div id="image-preview-modal" class="modal" style="display: none;">
  <div class="modal-content image-modal">
    <div class="modal-header d-flex justify-content-between align-items-center mb-2">
      <h5 class="modal-title">Image Preview</h5>
      <button type="button" class="close-btn" onclick="closeImageModal()">&times;</button>
    </div>
    <div class="modal-body">
      <img id="image-preview" src="" alt="Preview" style="max-width: 100%; max-height: 400px; display: block; margin: 0 auto 20px;" />
      <div id="image-meta-fields"></div>
      <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-secondary" onclick="closeImageModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Hard-nav shim: lets UserProfile menu bypass the modal router -->
<script>
// Disable the global entity modal router on this page to avoid re-opening issues
window.DISABLE_ENTITY_MODAL_ROUTER = true;
document.addEventListener("click", function(ev){
  const a = ev.target.closest('a[data-hard-nav="1"]');
  if(!a) return;
  ev.preventDefault(); ev.stopImmediatePropagation();
  window.location.href = a.href;
}, true);
// Force hard navigation for all sidebar links (bypass modal router entirely)
document.addEventListener("click", function(ev){
  const a = ev.target.closest('.sidebar a[href]');
  if(!a) return;
  const href = a.getAttribute('href');
  if(!href || href==="#") return;
  ev.preventDefault(); ev.stopImmediatePropagation();
  window.location.href = href;
}, true);
</script>
<!-- Removed inline AJAX UserProfile modal; using hard navigation instead -->
{% endblock %}
