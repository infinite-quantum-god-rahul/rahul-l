{% extends "base.html" %}
{% csrf_token %}
{% load custom_tags %}

{% block title %}Dashboard - Spoorthi MACS Ltd.,{% endblock %}

{% block content %}
<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle-btn" id="sidebar-toggle" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>

<div class="dashboard-flex">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <!-- Debug Info -->
    {% if debug %}
    <div class="alert alert-info">
      <strong>Debug Info:</strong><br>
      Role Flags: {{ role_flags|safe }}<br>
      User: {{ user.username }}<br>
      Is Superuser: {{ user.is_superuser }}<br>
      Is Staff: {{ user.is_staff }}
    </div>
    {% endif %}
    
    <ul class="sidebar-menu">
      <!-- SIDEBAR STRUCTURE: Superusers/Admins see ALL modules above, other roles see role-specific modules below (NO DUPLICATES) -->

      {% if user.is_superuser or role_flags.admin %}
        <!-- Superuser and Admin have access to everything -->
        <li class="dropdown">
          <a href="#">Create ▸</a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'UserCreation' %}">{{ "UserCreation"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">HRPM ▸</a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'hrpm_staff' %}">{{ "Staff"|pretty_name }}</a></li>
            <li><a href="{% url 'hrpm_appointment' %}">{{ "Appointment"|pretty_name }}</a></li>
            <li><a href="{% url 'hrpm_salary_statement' %}">{{ "Salary Statement"|pretty_name }}</a></li>
          </ul>
        </li>

        <!-- All modules for superuser and admin (NO DUPLICATES BELOW) -->
        {% for model in "Role,Product,Client,LoanApplication,LoanApproval,Disbursement,BusinessSetting,FieldSchedule,Prepaid,Mortgage,ExSaving,AccountHead,Voucher,Posting,RecoveryPosting,Payment,Repayment,LoanRestructure,Notification,GatewayEvent,EWIFlag"|split:"," %}
          <li><a href="{% url 'entity_list' model %}" data-hard-nav="1">{{ model|pretty_name }}</a></li>
        {% endfor %}
        <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'AlertRule' %}">{{ "AlertRule"|pretty_name }}</a></li>

        <li><a href="{% url 'npa_dashboard' %}">NPA Dashboard</a></li>
        <li><a href="#" onclick="openCreditPullModal()">Credit Bureau Check</a></li>

      {% elif role_flags.master or role_flags.manager %}
        <!-- Combined Create dropdown for Master and Manager roles (NO DUPLICATES) -->
        <li class="dropdown">
          <a href="#">Create ▸</a>
          <ul class="dropdown-menu">
            {% if role_flags.master %}
              <!-- Master role options -->
              <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'UserCreation' %}">{{ "UserCreation"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
            {% endif %}
            
            {% if role_flags.manager %}
              <!-- Manager role options -->
              <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Staff' %}">{{ "Staff"|pretty_name }}</a></li>
            {% endif %}
          </ul>
        </li>
      {% endif %}

      <!-- Core Business Modules (for non-superuser roles only - no duplicates) -->
      <!-- Client and LoanApplication are already available to superusers/admins above -->

      <!-- FieldSchedule is already available to superusers/admins above -->

      <!-- BusinessSetting is already available to superusers/admins above -->

      <!-- Financial Modules (no duplicates) -->
      <!-- All financial modules are already available to superusers/admins above -->

      <!-- Recovery and Field Modules (for non-superuser roles only - no duplicates) -->
      {% if role_flags.recovery_agent %}
        <li><a href="{% url 'entity_list' 'FieldReport' %}">{{ "FieldReport"|pretty_name }}</a></li>
      {% elif not role_flags.recovery_agent %}
        <!-- FieldReport available to ALL users by default (only if not already shown above) -->
        <li><a href="{% url 'entity_list' 'FieldReport' %}">{{ "FieldReport"|pretty_name }}</a></li>
      {% endif %}

      <!-- KYCDocument is already available to superusers/admins above -->

      <!-- Reports available to ALL users by default (no duplicates) -->
      <li class="dropdown">
        <a href="#">Report ▸</a>
        <ul class="dropdown-menu">
          <li><a href="{% url 'entity_list' 'WeeklyReport' %}">Weekly</a></li>
          <li><a href="{% url 'entity_list' 'MonthlyReport' %}">Monthly</a></li>
        </ul>
      </li>

    </ul>
  </div>

  <!-- Main Content -->
  <div class="admin-main-content">
    {% if include_template %}
      <!-- Entity-specific content (grid, forms, etc.) -->
      {% include include_template %}
    {% else %}
      <!-- Default dashboard content -->
      <div class="dashboard-header">
        <h1>Welcome to Spoorthi MACS Ltd.</h1>
        <p>Select an option from the sidebar to get started.</p>
      </div>

      <div class="dashboard-stats">
        <div class="stat-card">
          <h3>Quick Stats</h3>
          <p>Dashboard is ready for use.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Credit Bureau Modal -->
<div id="creditPullModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Credit Bureau Check</h2>
    <form id="creditPullForm">
      <div class="form-group">
        <label for="aadharNumber">Aadhar Number:</label>
        <input type="text" id="aadharNumber" name="aadhar_number" placeholder="1234 5678 9012" required>
      </div>
      <button type="submit">Check Credit Score</button>
    </form>
    <div id="creditResult"></div>
  </div>
</div>

<script>
// DASHBOARD-SPECIFIC TRUE ERROR FIX - Additional protection for this page
(function() {
    'use strict';
    console.log('🚨 DASHBOARD TRUE ERROR FIX - Additional protection for dashboard page');
    
    // Fix any existing required attributes immediately
    try {
        const requiredElements = document.querySelectorAll('[required]');
        let fixedCount = 0;
        requiredElements.forEach(element => {
            try {
                if (element.hasAttribute('required')) {
                    const requiredValue = element.getAttribute('required');
                    if (requiredValue === 'True') {
                        console.log(`❌ DASHBOARD: Element has required=True: ${element.name || element.id || 'unknown'}`);
                        element.setAttribute('required', 'required');
                        element.setAttribute('data-required', 'true');
                        element.dataset.required = 'true';
                        console.log(`✅ DASHBOARD: Element now has required="required"`);
                        fixedCount++;
                    }
                }
            } catch (error) {
                console.error('❌ Error fixing element in dashboard:', error);
            }
        });
        if (fixedCount > 0) {
            console.log(`🎉 DASHBOARD: Successfully fixed ${fixedCount} problematic required attributes!`);
        }
    } catch (error) {
        console.error('❌ Error in dashboard fix:', error);
    }
    
    console.log('🚨 DASHBOARD TRUE ERROR FIX complete - Dashboard page protected');
})();

// Sidebar toggle functionality
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.admin-main-content');
  const toggleBtn = document.querySelector('.sidebar-toggle-btn');
  
  // Add visual feedback
  if (toggleBtn) {
    toggleBtn.classList.add('clicked');
    setTimeout(() => toggleBtn.classList.remove('clicked'), 150);
  }
  
  if (sidebar.classList.contains('collapsed')) {
    // Expand sidebar
    sidebar.classList.remove('collapsed');
    mainContent.classList.remove('sidebar-collapsed');
  } else {
    // Collapse sidebar
    sidebar.classList.add('collapsed');
    mainContent.classList.add('sidebar-collapsed');
  }
}

// Auto-collapse sidebar on mobile
function checkMobile() {
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.admin-main-content');
    sidebar.classList.add('collapsed');
    mainContent.style.marginLeft = '0';
  }
}

// Check on load and resize
window.addEventListener('load', checkMobile);
window.addEventListener('resize', checkMobile);

// Add click event listener to toggle button
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.querySelector('.sidebar-toggle-btn');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', function(e) {
      toggleSidebar();
    });
    
    // Also add onclick as backup
    toggleBtn.onclick = function(e) {
      toggleSidebar();
    };
  }
});

function openCreditPullModal() {
  document.getElementById('creditPullModal').style.display = 'block';
}

// Close modal when clicking on X
document.querySelector('.close').onclick = function() {
  document.getElementById('creditPullModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  var modal = document.getElementById('creditPullModal');
  if (event.target == modal) {
    modal.style.display = 'none';
  }
}

// Handle credit pull form submission
document.getElementById('creditPullForm').onsubmit = function(e) {
  e.preventDefault();
  var aadhar = document.getElementById('aadharNumber').value;
  var resultDiv = document.getElementById('creditResult');
  
  resultDiv.innerHTML = '<p>Checking credit score for Aadhar: ' + aadhar + '</p>';
  // Add actual API call here
};
</script>
{% endblock %}