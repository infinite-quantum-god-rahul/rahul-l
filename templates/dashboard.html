{% extends "base.html" %}
{% csrf_token %}
{% load custom_tags %}

{% block title %}Dashboard - Spoorthi MACS Ltd.,{% endblock %}

{% block content %}
<!-- Original Sidebar Styles with Toggle Button -->
<style>
/* Restore original sidebar styling */
.sidebar {
  background: #0c1d32;
  color: #fff;
  position: fixed;
  top: 72px;
  left: 0;
  width: 250px;
  height: calc(100vh - 72px);
  overflow-y: auto;
  transition: transform .3s;
  z-index: 999;
  border-right: 2px solid #193a5a;
  box-shadow: 2px 0 5px rgba(0,0,0,0.3);
}
.sidebar.collapsed { 
  transform: translateX(-250px); 
}
.sidebar ul { 
  list-style: none; 
  padding: 0; 
  margin: 0; 
}
.sidebar ul li { 
  padding: 12px 20px; 
}
.sidebar ul li a {
  color: #fff;
  text-decoration: none;
  display: block;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  line-height: 1.4;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}
.sidebar ul li a:hover {
  background: #193a5a;
  border-radius: 4px;
  padding: 8px 12px;
  margin: -8px -12px;
}

/* Toggle button styling */
.sidebar-toggle-btn {
  position: fixed;
  top: 80px;
  left: 10px;
  font-size: 18px;
  color: #fff;
  background: #173651;
  border: none;
  border-radius: 4px;
  padding: 10px 12px;
  cursor: pointer;
  z-index: 1100;
  transition: all .3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  min-width: 40px;
  text-align: center;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}
.sidebar-toggle-btn:hover {
  background: #0f2b41;
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

/* Dropdown functionality */
.sidebar .dropdown-menu {
  display: none;
  background: #132a44;
  padding-left: 20px;
  border-left: 2px solid #193a5a;
  margin-left: 10px;
}
.sidebar .dropdown.open > .dropdown-menu {
  display: block;
}
.sidebar .dropdown-menu li {
  padding: 4px 0;
}
.sidebar .dropdown-menu li a {
  color: #fff;
  font-size: 13px;
  padding: 8px 15px;
  font-weight: normal;
}
.sidebar .dropdown-menu li a:hover {
  background: #1a3d5c;
}

/* Main content adjustment when sidebar is visible */
.admin-main-content {
  margin-left: 250px;
  transition: margin-left .3s;
}
.sidebar.collapsed ~ .admin-main-content {
  margin-left: 0;
}
</style>

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle-btn" id="sidebar-toggle" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>

<div class="dashboard-flex">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <!-- Debug Info -->
    {% if debug %}
    <div class="alert alert-info">
      <strong>Debug Info:</strong><br>
      Role Flags: {{ role_flags|safe }}<br>
      User: {{ user.username }}<br>
      Is Superuser: {{ user.is_superuser }}<br>
      Is Staff: {{ user.is_staff }}
    </div>
    {% endif %}
    
    <ul class="sidebar-menu">

      {% if user.is_superuser %}
        <!-- Superuser has access to everything -->
        <li class="dropdown">
          <a href="#">Create ▸</a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Users' %}">{{ "Users"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">HRPM ▸</a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'hrpm_staff' %}">{{ "Staff"|pretty_name }}</a></li>
            <li><a href="{% url 'hrpm_appointment' %}">{{ "Appointment"|pretty_name }}</a></li>
            <li><a href="{% url 'hrpm_salary_statement' %}">{{ "Salary Statement"|pretty_name }}</a></li>
          </ul>
        </li>

        <!-- All modules for superuser -->
        {% for model in "Role,Product,Client,LoanApplication,LoanApproval,Disbursement,BusinessSetting,FieldSchedule,Prepaid,Mortgage,ExSaving,AccountHead,Voucher,Posting,RecoveryPosting,UserPermission,Payment,Repayment,LoanRestructure,Notification,GatewayEvent,EWIFlag"|split:"," %}
          <li><a href="{% url 'entity_list' model %}" data-hard-nav="1">{{ model|pretty_name }}</a></li>
        {% endfor %}
        <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'AlertRule' %}">{{ "AlertRule"|pretty_name }}</a></li>

        <li><a href="{% url 'npa_dashboard' %}">NPA Dashboard</a></li>
        <li><a href="#" onclick="openCreditPullModal()">Credit Bureau Check</a></li>

      {% elif role_flags.admin %}
        <!-- Admin users have same powers as superuser -->
        <li class="dropdown">
          <a href="#">Create ▸</a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Users' %}">{{ "Users"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
            <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">HRPM ▸</a>
          <ul class="dropdown-menu">
            <li><a href="{% url 'hrpm_staff' %}">{{ "Staff"|pretty_name }}</a></li>
            <li><a href="{% url 'hrpm_appointment' %}">{{ "Appointment"|pretty_name }}</a></li>
            <li><a href="{% url 'hrpm_salary_statement' %}">{{ "Salary Statement"|pretty_name }}</a></li>
          </ul>
        </li>

        <!-- All modules for admin (same as superuser) -->
        {% for model in "Role,Product,Client,LoanApplication,LoanApproval,Disbursement,BusinessSetting,FieldSchedule,Prepaid,Mortgage,ExSaving,AccountHead,Voucher,Posting,RecoveryPosting,UserPermission,Payment,Repayment,LoanRestructure,Notification,GatewayEvent,EWIFlag"|split:"," %}
          <li><a href="{% url 'entity_list' model %}" data-hard-nav="1">{{ model|pretty_name }}</a></li>
        {% endfor %}
        <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'AlertRule' %}">{{ "AlertRule"|pretty_name }}</a></li>

        <li><a href="{% url 'npa_dashboard' %}">NPA Dashboard</a></li>
        <li><a href="#" onclick="openCreditPullModal()">Credit Bureau Check</a></li>
      {% endif %}

      {% if role_flags.master or role_flags.manager %}
        <!-- Combined Create dropdown for Master and Manager roles -->
        <li class="dropdown">
          <a href="#">Create ▸</a>
          <ul class="dropdown-menu">
            {% if role_flags.master %}
              <!-- Master role options -->
              <li><a href="{% url 'entity_list' 'Company' %}">{{ "Company"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Branch' %}">{{ "Branch"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Users' %}">{{ "Users"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'UserPermission' %}">{{ "UserPermission"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Cadre' %}">{{ "Cadre"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Column' %}">{{ "Column"|pretty_name }}</a></li>
            {% endif %}
            
            {% if role_flags.manager %}
              <!-- Manager role options -->
              <li><a href="{% url 'entity_list' 'Village' %}">{{ "Village"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Center' %}">{{ "Center"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Group' %}">{{ "Group"|pretty_name }}</a></li>
              <li><a href="{% url 'entity_list' 'Staff' %}">{{ "Staff"|pretty_name }}</a></li>
            {% endif %}
          </ul>
        </li>
      {% endif %}

      <!-- Core Business Modules (no duplicates) -->
      {% if role_flags.manager or role_flags.data_entry or role_flags.recovery_agent or user.is_staff %}
        <li><a href="{% url 'entity_list' 'Client' %}">{{ "Client"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'LoanApplication' %}">{{ "LoanApplication"|pretty_name }}</a></li>
      {% endif %}

      {% if role_flags.manager or role_flags.data_entry %}
        <li><a href="{% url 'entity_list' 'FieldSchedule' %}">{{ "FieldSchedule"|pretty_name }}</a></li>
      {% endif %}

      {% if role_flags.manager %}
        <li><a href="{% url 'entity_list' 'BusinessSetting' %}">{{ "BusinessSetting"|pretty_name }}</a></li>
      {% endif %}

      <!-- Financial Modules (no duplicates) -->
      {% if role_flags.manager or role_flags.accounting %}
        <li><a href="{% url 'entity_list' 'AccountHead' %}">{{ "AccountHead"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'Voucher' %}">{{ "Voucher"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'Posting' %}">{{ "Posting"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'Payment' %}">{{ "Payment"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'RecoveryPosting' %}">{{ "RecoveryPosting"|pretty_name }}</a></li>
        <li><a href="{% url 'entity_list' 'Repayment' %}">{{ "Repayment"|pretty_name }}</a></li>
      {% endif %}

      <!-- Recovery and Field Modules (no duplicates) -->
      {% if role_flags.recovery_agent %}
        <li><a href="{% url 'entity_list' 'FieldReport' %}">{{ "FieldReport"|pretty_name }}</a></li>
      {% endif %}

      {% if role_flags.auditor %}
        <!-- Auditor users have audit access -->
        <li><a href="{% url 'entity_list' 'KYCDocument' %}">{{ "KYCDocument"|pretty_name }}</a></li>
      {% endif %}

      <!-- FieldReport available to ALL users by default -->
      <li><a href="{% url 'entity_list' 'FieldReport' %}">{{ "FieldReport"|pretty_name }}</a></li>

      <!-- Reports available to ALL users by default -->
      <li class="dropdown">
        <a href="#">Report ▸</a>
        <ul class="dropdown-menu">
          <li><a href="{% url 'entity_list' 'WeeklyReport' %}">Weekly</a></li>
          <li><a href="{% url 'entity_list' 'MonthlyReport' %}">Monthly</a></li>
        </ul>
      </li>

    </ul>
  </div>

  <!-- Main Content -->
  <div class="admin-main-content">
    {% if include_template %}
      <!-- Entity-specific content (grid, forms, etc.) -->
      {% include include_template %}
    {% else %}
      <!-- Default dashboard content -->
      <div class="dashboard-header">
        <h1>Welcome to Spoorthi MACS Ltd.</h1>
        <p>Select an option from the sidebar to get started.</p>
      </div>

      <div class="dashboard-stats">
        <div class="stat-card">
          <h3>Quick Stats</h3>
          <p>Dashboard is ready for use.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Credit Bureau Modal -->
<div id="creditPullModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Credit Bureau Check</h2>
    <form id="creditPullForm">
      <div class="form-group">
        <label for="aadharNumber">Aadhar Number:</label>
        <input type="text" id="aadharNumber" name="aadhar_number" placeholder="1234 5678 9012" required>
      </div>
      <button type="submit">Check Credit Score</button>
    </form>
    <div id="creditResult"></div>
  </div>
</div>

<script>
// Sidebar toggle functionality
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.admin-main-content');
  const toggleBtn = document.querySelector('.sidebar-toggle-btn');
  
  // Add visual feedback
  if (toggleBtn) {
    toggleBtn.classList.add('clicked');
    setTimeout(() => toggleBtn.classList.remove('clicked'), 150);
  }
  
  if (sidebar.classList.contains('collapsed')) {
    // Expand sidebar
    sidebar.classList.remove('collapsed');
    mainContent.classList.remove('sidebar-collapsed');
  } else {
    // Collapse sidebar
    sidebar.classList.add('collapsed');
    mainContent.classList.add('sidebar-collapsed');
  }
}

// Auto-collapse sidebar on mobile
function checkMobile() {
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.admin-main-content');
    sidebar.classList.add('collapsed');
    mainContent.style.marginLeft = '0';
  }
}

// Check on load and resize
window.addEventListener('load', checkMobile);
window.addEventListener('resize', checkMobile);

// Add click event listener to toggle button
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.querySelector('.sidebar-toggle-btn');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', function(e) {
      toggleSidebar();
    });
    
    // Also add onclick as backup
    toggleBtn.onclick = function(e) {
      toggleSidebar();
    };
  }
});

function openCreditPullModal() {
  document.getElementById('creditPullModal').style.display = 'block';
}

// Close modal when clicking on X
document.querySelector('.close').onclick = function() {
  document.getElementById('creditPullModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  var modal = document.getElementById('creditPullModal');
  if (event.target == modal) {
    modal.style.display = 'none';
  }
}

// Handle credit pull form submission
document.getElementById('creditPullForm').onsubmit = function(e) {
  e.preventDefault();
  var aadhar = document.getElementById('aadharNumber').value;
  var resultDiv = document.getElementById('creditResult');
  
  resultDiv.innerHTML = '<p>Checking credit score for Aadhar: ' + aadhar + '</p>';
  // Add actual API call here
};

// Original Dropdown functionality and Sidebar Toggle
document.addEventListener('DOMContentLoaded', function() {
  // Sidebar toggle functionality
  window.toggleSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.admin-main-content');
    
    if (sidebar) {
      sidebar.classList.toggle('collapsed');
    }
  };
  
  // Handle dropdown clicks
  const dropdowns = document.querySelectorAll('.sidebar .dropdown > a');
  
  dropdowns.forEach(function(dropdownLink) {
    dropdownLink.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const dropdown = this.parentElement;
      const isOpen = dropdown.classList.contains('open');
      
      // Close all other dropdowns first
      document.querySelectorAll('.sidebar .dropdown').forEach(function(otherDropdown) {
        if (otherDropdown !== dropdown) {
          otherDropdown.classList.remove('open');
        }
      });
      
      // Toggle current dropdown
      if (!isOpen) {
        dropdown.classList.add('open');
      } else {
        dropdown.classList.remove('open');
      }
    });
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.sidebar .dropdown')) {
      document.querySelectorAll('.sidebar .dropdown').forEach(function(dropdown) {
        dropdown.classList.remove('open');
      });
    }
  });
});
</script>
{% endblock %}