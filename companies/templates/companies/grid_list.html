{% load static %}
{% load custom_tags %}

<div class="grid-container" data-entity="{{ entity }}">
  <!-- Lightbox (thumbnail preview) -->
  <style>
    .img-thumb{width:48px;height:48px;object-fit:cover;border-radius:6px;cursor:pointer}
    .lightbox-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999}
    .lightbox-backdrop.active{display:block}
    .lightbox-inner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90vw;max-height:90vh}
    .lightbox-inner img{max-width:90vw;max-height:90vh;display:block}
    .lightbox-close{position:absolute;top:10px;right:16px;color:#fff;font-size:22px;cursor:pointer}
  </style>
  <div id="lightbox" class="lightbox-backdrop" onclick="LB.close(event)">
    <div class="lightbox-close" onclick="LB.forceClose()">✕</div>
    <div class="lightbox-inner"><img id="lightbox-img" src=""></div>
  </div>
  <script>
    const LB={open:(s)=>{const i=document.getElementById('lightbox-img');i.src=s;document.getElementById('lightbox').classList.add('active')},
              close:(e)=>{if(e.target.id==='lightbox')LB.forceClose()},
              forceClose:()=>{document.getElementById('lightbox').classList.remove('active');document.getElementById('lightbox-img').src=''}};
  </script>

  <!-- Header with Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ pretty_entity }}</h2>

    {# SPECIAL-CASE: UserProfile must hard-navigate, not open modal #}
    {% if entity|lower == "userprofile" %}
      <a class="btn btn-success"
         data-hard-nav="1"
         href="{% url 'userprofile_get' %}">
        <i class="fas fa-plus"></i> Add
      </a>

    {% elif user.is_superuser %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>
    {% elif profile and profile.is_admin %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>
    {% elif profile and profile.is_master %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>

    {# Data Entry scope #}
    {% elif profile and profile.is_data_entry and entity|lower|in_list:"client,loanapplication,recoveryposting" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>

    {# Accounting scope #}
    {% elif profile and profile.is_accounting and entity|lower|in_list:"voucher,posting,accounthead" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>

    {# Manager: union of DE + ACC menus #}
    {% elif profile and profile.is_manager and entity|lower|in_list:"client,loanapplication,recoveryposting" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>
    {% elif profile and profile.is_manager and entity|lower|in_list:"voucher,posting,accounthead" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>

    {# Recovery Agent: RecoveryPosting only #}
    {% elif profile and profile.is_recovery_agent and entity|lower == "recoveryposting" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>

    {# Reports & Auditor: enable Add for report entities #}
    {% elif profile and profile.is_reports and entity|lower|in_list:"fieldreport,weeklyreport,monthlyreport" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>
    {% elif profile and profile.is_auditor and entity|lower|in_list:"fieldreport,weeklyreport,monthlyreport" %}
      <button
        class="btn btn-success btn-add"
        id="create-{{ entity }}-btn"
        data-open-entity="{{ entity }}"
        onclick="openEntityModal('{{ entity }}')"
        role="button">
        <i class="fas fa-plus"></i> Add
      </button>
    {% endif %}
  </div>

  <!-- TABLE / GROUP LOOP -->
  {% for group_name, objects in grouped_objects.items %}
    <div class="mb-4">
      {% if group_name %}
        <h5 class="text-primary">{{ group_name }}</h5>
      {% endif %}

      {% if objects and objects.0 %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                {% if spec_grid and spec_grid|length %}
                  {% for f in spec_grid %}
                    {% with lbl=f|cut:"extra__"|replace_underscore %}
                      <th>{{ lbl }}</th>
                    {% endwith %}
                  {% endfor %}
                  <th>Actions</th>
                {% else %}
                  {% for field in objects.0|get_fields %}
                    {% if field.name|in_list:"extra_data,raw_csv_data,password" %}
                    {% elif entity|lower == "staff" and field.name|in_list:"status,ifsc,bank,designation" %}
                    {% elif entity|lower == "userprofile" and field.name|in_list:"is_admin,is_master,is_data_entry,is_accounting,is_recovery_agent,is_auditor,is_manager" %}
                    {% else %}
                      {% if entity|lower == "userprofile" and field.name == "user" %}
                        <th>Username</th>
                      {% else %}
                        <th>{{ field.verbose_name|replace_underscore }}</th>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% for col in column_fields %}
                    <th>{{ col.label }}</th>
                  {% endfor %}
                  <th>Actions</th>
                {% endif %}
              </tr>
            </thead>

            <tbody>
              {% for obj in objects %}
                {% with st=obj|attr:"status" ia=obj|attr:"is_active" ac=obj|attr:"active" stn=st|default_if_none:"__none__" ian=ia|default_if_none:"__none__" acn=ac|default_if_none:"__none__" %}
                  {% if st|stringformat:"s"|lower == "active" or st|stringformat:"s" == "1" or ia or ac or stn == "__none__" and ian == "__none__" and acn == "__none__" %}
                    <tr data-id="{{ obj.pk }}">

                      {% if spec_grid and spec_grid|length %}
                        {% for f in spec_grid %}
                          {% with fl=f|lower %}
                            <td>
                              {% if not fl|slice:":7" == "extra__" and obj|attr:f %}
                                {% if fl|in_list:"photo,live_photo,house_photo,logo,image,picture,avatar" %}
                                  {% with file=obj|attr:f %}
                                    {% if file %}
                                      {% if file.url %}
                                        {% with imgurl=file.url %}
                                          <img class="img-thumb" src="{{ imgurl }}" onclick="LB.open('{{ imgurl }}')" alt="img">
                                        {% endwith %}
                                      {% else %}
                                        {% with imgurl=file %}
                                          <img class="img-thumb" src="{{ imgurl }}" onclick="LB.open('{{ imgurl }}')" alt="img">
                                        {% endwith %}
                                      {% endif %}
                                    {% endif %}
                                  {% endwith %}
                                {% else %}
                                  {{ obj|attr:f|format_ddmmyyyy }}
                                {% endif %}
                              {% else %}
                                {% with exk=f|cut:"extra__" %}
                                  {% with val=obj.extra_data|get_item:exk|default:obj.extra_data|get_item:f %}
                                    {% if val %}
                                      {% if "file" in fl or "image" in fl or "document" in fl %}
                                        <a href="{{ val }}" target="_blank" title="View">View</a>
                                      {% else %}
                                        {{ val|format_ddmmyyyy }}
                                      {% endif %}
                                    {% endif %}
                                  {% endwith %}
                                {% endwith %}
                              {% endif %}
                            </td>
                          {% endwith %}
                        {% endfor %}

                      {% else %}
                        {% for field in obj|get_fields %}
                          {% if field.name|in_list:"extra_data,raw_csv_data,password" %}
                          {% elif entity|lower == "staff" and field.name|in_list:"status,ifsc,bank,designation" %}
                          {% elif entity|lower == "userprofile" and field.name|in_list:"is_admin,is_master,is_data_entry,is_accounting,is_recovery_agent,is_auditor,is_manager" %}
                          {% else %}
                            <td>
                              {% if entity|lower == "userprofile" and field.name == "user" %}
                                {{ obj.extra_data|get_item:"auth_username"|default_if_none:"" }}
                              {% else %}
                                {% if field.name|in_list:"photo,live_photo,house_photo,logo,image,picture,avatar" and obj|attr:field.name %}
                                  {% with file=obj|attr:field.name %}
                                    {% if file %}
                                      {% if file.url %}
                                        {% with imgurl=file.url %}
                                          <img class="img-thumb" src="{{ imgurl }}" onclick="LB.open('{{ imgurl }}')" alt="img">
                                        {% endwith %}
                                      {% else %}
                                        {% with imgurl=file %}
                                          <img class="img-thumb" src="{{ imgurl }}" onclick="LB.open('{{ imgurl }}')" alt="img">
                                        {% endwith %}
                                      {% endif %}
                                    {% endif %}
                                  {% endwith %}
                                {% else %}
                                  {{ obj|attr:field.name|format_ddmmyyyy }}
                                {% endif %}
                              {% endif %}
                            </td>
                          {% endif %}
                        {% endfor %}

                        {% for col in column_fields %}
                          <td>
                            {% if col.field_type == 'file' and obj.extra_data|get_item:col.field_name %}
                              <a href="{{ obj.extra_data|get_item:col.field_name }}" target="_blank" title="Download File">View</a>
                            {% else %}
                              {{ obj.extra_data|get_item:col.field_name|format_ddmmyyyy }}
                            {% endif %}
                          </td>
                        {% endfor %}
                      {% endif %}

                      <td class="d-flex gap-1">
                        <button
                          class="btn btn-sm btn-warning btn-edit"
                          data-edit-entity="{{ entity }}"
                          data-id="{{ obj.pk }}"
                          onclick="editEntity('{{ entity }}', {{ obj.pk }})"
                          aria-label="Edit {{ obj }}" title="Edit {{ obj }}">
                          <i class="fas fa-edit"></i> Edit
                        </button>

                        <button
                          class="btn btn-sm btn-danger btn-delete"
                          data-delete-entity="{{ entity }}"
                          data-id="{{ obj.pk }}"
                          onclick="deleteEntity('{{ entity }}', {{ obj.pk }})"
                          aria-label="Delete {{ obj }}" title="Delete {{ obj }}">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </td>
                    </tr>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-warning">
          No records found under {{ group_name|default:"this group" }}.
        </div>
      {% endif %}
    </div>
  {% empty %}
    <div class="alert alert-info">No data available.</div>
  {% endfor %}
</div>

{% if page_obj %}
<nav class="pager mt-3">
  <div class="pager-left">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}&page_size={{ page_obj.per_page }}">« Prev</a>
    {% endif %}
  </div>
  <div class="pager-center">
    Page {{ page_obj.number }} · showing {{ page_obj.start_index }}–{{ page_obj.end_index }}
  </div>
  <div class="pager-right">
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&page_size={{ page_obj.per_page }}">Next »</a>
    {% endif %}
  </div>
</nav>
{% endif %}

{% include "companies/modal_form.html" %}

<style>
  .btn-danger{display:inline-flex!important;visibility:visible!important;opacity:1!important}
</style>

{# Shim: make any link with data-hard-nav="1" bypass modal router #}
<script>
document.addEventListener("click",function(e){
  const a=e.target.closest('a[data-hard-nav="1"]'); if(!a) return;
  e.preventDefault(); e.stopImmediatePropagation(); window.location.href=a.href;
},true);
</script>
